name : Building and Deploying  container image to AWS ECR and ECS

on:

    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]
permissions:
  id-token: write
  contents: read
  
env:
    aws_region: us-east-1
    AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
    ECR_REPOSITORY: uat
    IMAGE_TAG: ${{ github.run_number }}
    TASK_DEFINITION: demo-task
    CLUSTER: staging-cluster
    SERVICE: demo-service
    CONTAINER_NAME: nginx
  
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code from Repo
              uses: actions/checkout@v4

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
                  aws-region: ${{ env.aws_region }}

            - name: Login to Amazon ECR
              uses: aws-actions/amazon-ecr-login@v2
              id: login-ecr
            - name: Install Trivy
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: fs
                  severity: HIGH,CRITICAL
                  exit-code: 0
                  format: table
                  ignore-unfixed: true
            - name: Build, Tag Image
              id: build-image
              run : |
                docker build -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} .
                echo "::set-output name=image::${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}"
            - name: Scanning Image with Trivy
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
                  format: table
                  severity: HIGH,CRITICAL
                  exit-code: 0
                  ignore-unfixed: true
            - name: Push Image Tag to ECR
              run: |
                docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
                echo "IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
                
    Deploy:
        runs-on: ubuntu-latest
        needs: build  # Depends on Build job
        steps:
          - name: AWS Creds Config 
            uses: aws-actions/configure-aws-credentials@v4
            with:
              role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
              aws-region: ${{ env.aws_region }}
          
          - name: Download current task definition
            run: |
              aws ecs describe-task-definition --task-definition ${{ env.TASK_DEFINITION }} --query taskDefinition > task-definition.json
          
          - name: Update task definition with new ECR image
            run: |
              jq --arg IMAGE_URI "${{ needs.Build.outputs.image-uri }}" '.containerDefinitions[0].image = $IMAGE_URI | 
              del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy, .deregisteredAt)' task-definition.json > register-task-definition.json
          
          - name: Register new task definition
            run: |
              aws ecs register-task-definition --cli-input-json file://register-task-definition.json
              echo "NEW_TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition ${{ env.TASK_DEFINITION }} --query 'taskDefinition.taskDefinitionArn' --output text)" >> $GITHUB_ENV
          
          - name: Update ECS service
            run: |
              aws ecs update-service --cluster ${{ env.CLUSTER }} --service ${{ env.SERVICE }} --task-definition ${{ env.TASK_DEFINITION }} --force-new-deployment